{% extends "teacher/teacher_base.html" %}
{% load static %}
{% load dict_extras %}
{% block title %}Attendance{% endblock %}
{% block content %}

<div class="col-md-10 main-content">
  <div class="d-flex justify-content-between align-items-center flex-wrap attendance-header mb-3">
    <div class="daily-attendance d-flex align-items-center">
      <h5 class="mb-0">Mark Daily Attendance</h5>
    </div>

    <!-- Scan Fingerprints Button -->
    <button id="scanBtn" class="btn btn-scan glow">
      <i class="fas fa-fingerprint"></i> Scan Fingerprints
    </button>
  </div>

  <!-- ✅ Scanner Controls -->
  <!-- <div class="scanner-controls d-flex align-items-center mb-3">
    <button class="btn btn-outline-success btn-sm me-2" id="startScannerBtn">🟢 Start Scanner</button>
    <button class="btn btn-outline-danger btn-sm me-2" id="stopScannerBtn">🔴 Stop Scanner</button>
    <span id="scannerStatus" class="text-muted">Checking scanner status...</span>
  </div> -->

  <!-- Date Alert -->
  <div class="alert alert-light border-start border-primary border-1 rounded px-3 py-2 d-inline-flex align-items-center mb-3 date-alert" style="border-radius: 50px !important;">
    <span class="fw-semibold">Today: <span style="font-weight: 900;">{{ today }}</span></span>
  </div>

  <!-- Attendance Table -->
  <div class="table-responsive mt-3">
    <table class="table modern-table">
      <thead>
        <tr>
          <th>Student</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr>
          <td><strong>{{ s.firstname }} {{ s.lastname }}</strong></td>
          {% if s.id in present_ids %}
          <td><i class="fas fa-user-check text-success me-1"></i> Present</td>
          <td><i class="fas fa-clock me-1 text-muted"></i>{{ present_times|lookup:s.id }}</td>
          {% else %}
          <td class="text-muted">—</td>
          <td class="text-muted">—</td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="text-center text-muted">No students.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PDF Button -->
  <div class="text-end mt-3">
    <a href="{% url 'teacher:attendance_pdf' day=today|date:'Y-m-d' %}" class="btn btn-download">
      <i class="fas fa-file-pdf me-2"></i>Download PDF
    </a>
  </div>
</div>

<!-- Scan Status Modal -->
<div class="modal fade" id="scanModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5 class="modal-title">Fingerprint Attendance</h5>
      <p id="modalMsg" class="mb-0"></p>
    </div>
  </div>
</div>

<!-- Email Notification Warning -->
<!-- 
{% if not request.user.teacher_profile.school.subscription.plan.has_email_notifications %}
  <div class="alert alert-warning mt-4">
    📭 Email alerts to parents are not available on your current plan.
  </div>
{% endif %} -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- new script -->
<!-- 
<script>
const modal    = new bootstrap.Modal(document.getElementById("scanModal"));
const modalMsg = document.getElementById("modalMsg");

function show(msg) {
  modalMsg.textContent = msg;
  modal.show();
}

// ---------- URLS ----------
const SCAN_URL     = "{% url 'teacher:attendance_scan' %}";
const API_BASE     = "http://localhost:8002";  // ✅ Update if hosted elsewhere
const PING_URL     = `${API_BASE}/ping`;
const START_URL    = `${API_BASE}/start_scanner`;
const STOP_URL     = `${API_BASE}/stop_scanner`;

// ---------- Scan Fingerprint ----------
document.getElementById("scanBtn").addEventListener("click", () => {
  show("Place finger on reader…");

  fetch(SCAN_URL, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
    .then(r => r.json())
    .then(d => {
      if (d.match) {
        show(`✅ Marked present: ${d.student} at ${d.time}`);
      } else {
        show("❌ No matching student found.");
      }
      setTimeout(() => location.reload(), 1500);
    })
    .catch(() => show("⚠️ Scanner error – is FastAPI server running?"));
});

// ---------- Start Scanner ----------
document.getElementById("startScannerBtn").addEventListener("click", () => {
  fetch(START_URL)
    .then(r => r.json())
    .then(() => {
      document.getElementById("scannerStatus").textContent = "🟢 Scanner started";
    })
    .catch(() => {
      document.getElementById("scannerStatus").textContent = "❌ Failed to start scanner";
    });
});

// ---------- Stop Scanner ----------
document.getElementById("stopScannerBtn").addEventListener("click", () => {
  fetch(STOP_URL)
    .then(r => r.json())
    .then(() => {
      document.getElementById("scannerStatus").textContent = "🔴 Scanner stopped";
    })
    .catch(() => {
      document.getElementById("scannerStatus").textContent = "❌ Failed to stop scanner";
    });
});

// ---------- Ping Status Check ----------
function checkScannerStatus() {
  fetch(PING_URL)
    .then(r => r.json())
    .then(d => {
      if (d.status === "ok") {
        document.getElementById("scannerStatus").textContent = "🟢 Scanner online";
      } else {
        document.getElementById("scannerStatus").textContent = "🔴 Scanner offline";
      }
    })
    .catch(() => {
      document.getElementById("scannerStatus").textContent = "🔴 Scanner offline";
    });
}

checkScannerStatus();  // Ping scanner on load
</script> -->

<script>
const modal    = new bootstrap.Modal(document.getElementById("scanModal"));
const modalMsg = document.getElementById("modalMsg");

function show(msg) {
  modalMsg.textContent = msg;
  modal.show();
}

// ---------- URLS ----------
const SCAN_URL     = "{% url 'teacher:attendance_scan' %}";
const API_BASE     = "http://localhost:8001";  // ✅ Update if hosted elsewhere
const PING_URL     = `${API_BASE}/ping`;
const START_URL    = `${API_BASE}/start_scanner`;
const STOP_URL     = `${API_BASE}/stop_scanner`;

// ---------- Scan Fingerprint ----------
document.getElementById("scanBtn").addEventListener("click", () => {
  show("Place finger on reader…");

  fetch(SCAN_URL, {
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
    .then(r => r.json())
    .then(d => {
      if (d.match) {
        show(`✅ Marked present: ${d.student} at ${d.time}`);
      } else {
        show("❌ No matching student found.");
      }
      setTimeout(() => location.reload(), 1500);
    })
    .catch(() => show("⚠️ Scanner error – is FastAPI server running?"));
});

// ---------- Start Scanner ----------
document.getElementById("startScannerBtn").addEventListener("click", () => {
  fetch(START_URL)
    .then(r => r.json())
    .then(() => {
      document.getElementById("scannerStatus").textContent = "🟢 Scanner started";
    })
    .catch(() => {
      document.getElementById("scannerStatus").textContent = "❌ Failed to start scanner";
    });
});

// ---------- Stop Scanner ----------
document.getElementById("stopScannerBtn").addEventListener("click", () => {
  fetch(STOP_URL)
    .then(r => r.json())
    .then(() => {
      document.getElementById("scannerStatus").textContent = "🔴 Scanner stopped";
    })
    .catch(() => {
      document.getElementById("scannerStatus").textContent = "❌ Failed to stop scanner";
    });
});

// ---------- Ping Status Check ----------
function checkScannerStatus() {
  fetch(PING_URL)
    .then(r => r.json())
    .then(d => {
      if (d.status === "ok") {
        document.getElementById("scannerStatus").textContent = "🟢 Scanner online";
      } else {
        document.getElementById("scannerStatus").textContent = "🔴 Scanner offline";
      }
    })
    .catch(() => {
      document.getElementById("scannerStatus").textContent = "🔴 Scanner offline";
    });
}

checkScannerStatus();  // Ping scanner on load
</script>  





<!-- previous working script -->
<!-- <script>
const modal    = new bootstrap.Modal(document.getElementById("scanModal"));
const modalMsg = document.getElementById("modalMsg");
const SCAN_URL = "{% url 'teacher:attendance_scan' %}";

function show(msg){ modalMsg.textContent = msg; modal.show(); }

document.getElementById("scanBtn").addEventListener("click", () => {
  show("Place finger on reader…");
  fetch(SCAN_URL, {headers: {"X-Requested-With":"XMLHttpRequest"}})
    .then(r => r.json())
    .then(d => {
      if (d.match){
        show(`✅ Marked present: ${d.student} at ${d.time}`);
      }else{
        show("❌ No matching student found.");
      }
      setTimeout(() => location.reload(), 1500);
    })
    .catch(() => show("⚠️ Scanner error – is FastAPI running?"));
});
</script> -->

{% endblock %}
